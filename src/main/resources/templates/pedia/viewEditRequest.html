<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>멍피디아 - 관리자</title>


  <script>

    function handleApprove(reqId, userEmail) {
      // // 부모 요소에서 data-* 속성 읽기
      // const postItem = button.closest('.post-item'); // 버튼의 부모 요소 찾기
      // const code = postItem.getAttribute('data-board-id');
      // const memberEmail = postItem.getAttribute('data-member-email');
      //
      // console.log('Board ID:', boardId);
      // console.log('Member Email:', memberEmail);

      // Fetch API를 통해 수정 승인 요청 보내기

      console.log(reqId);
      console.log(userEmail);

      fetch('/RequestAccept', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          "code": reqId,
          "memberEmail": userEmail
        }),
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('네트워크 응답 오류');
        }
        return response.json();
      })
      .then(data => {
        alert('수정 요청이 승인되었습니다.');
        window.location.reload(); // 필요시 페이지 리로드
      })
      .catch(error => {
        console.error('에러 발생:', error);
      });
    }

    function handleDecline(reqId, userEmail) {
      // // 부모 요소에서 data-* 속성 읽기
      // const postItem = button.closest('.post-item'); // 버튼의 부모 요소 찾기
      // const code = postItem.getAttribute('data-board-id');
      // const memberEmail = postItem.getAttribute('data-member-email');
      //
      // console.log('Board ID:', boardId);
      // console.log('Member Email:', memberEmail);

      // Fetch API를 통해 수정 승인 요청 보내기

      console.log(reqId);
      console.log(userEmail);

      fetch('/RequestDecline', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          "code": reqId,
          "memberEmail": userEmail
        }),
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('네트워크 응답 오류');
        }
        return response.json();
      })
      .then(data => {
        alert('수정 요청이 승인되었습니다.');
        window.location.reload(); // 필요시 페이지 리로드
      })
      .catch(error => {
        console.error('에러 발생:', error);
      });
    }

    function handleShowDetail(id) {
            .file-label {
                padding: 0.75rem 1rem;
            }
        }
    </style>
    <script>

        function handleApprove(reqId, userEmail, reqBreed) {
            // // 부모 요소에서 data-* 속성 읽기
            // const postItem = button.closest('.post-item'); // 버튼의 부모 요소 찾기
            // const code = postItem.getAttribute('data-board-id');
            // const memberEmail = postItem.getAttribute('data-member-email');
            //
            // console.log('Board ID:', boardId);
            // console.log('Member Email:', memberEmail);

            // Fetch API를 통해 수정 승인 요청 보내기


            console.log(reqId);
            console.log(userEmail);
            console.log(reqBreed)

            fetch('/RequestAccept', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    "code": reqId,
                    "memberEmail": userEmail,
                    "breed":reqBreed
                }),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('네트워크 응답 오류');
                    }
                    return response.text();
                })
                .then(data => {
                    alert('수정 요청이 승인되었습니다.');
                    // window.location.href = "/view-edit-request";
                    location.reload();
                })
                .catch(error => {
                    console.error('에러 발생:', error);
                });

        }
        return response.json();
      })
      .then(data => {
        
        function handleDecline(reqId, userEmail) {
            // // 부모 요소에서 data-* 속성 읽기
            // const postItem = button.closest('.post-item'); // 버튼의 부모 요소 찾기
            // const code = postItem.getAttribute('data-board-id');
            // const memberEmail = postItem.getAttribute('data-member-email');
            //
            // console.log('Board ID:', boardId);
            // console.log('Member Email:', memberEmail);

            // Fetch API를 통해 수정 승인 요청 보내기


            console.log(reqId);
            console.log(userEmail);


            fetch('/RequestDecline', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    "code": reqId,
                    "memberEmail": userEmail,
                }),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('네트워크 응답 오류');
                    }
                    return response.text();
                })
                .then(data => {
                    alert('수정 거절이 승인되었습니다.');
                    location.reload();
                })
                .catch(error => {
                    console.error('에러 발생:', error);
                });
        }
        function handleShowDetail(id) {

            fetch(`/viewEditRequestDetail?id=${encodeURIComponent(id)}`, {
                redirect: 'follow'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('네트워크 응답 오류');
                    }
                    return response.json();
                })
                .then(data => {

                    console.log(data)
                })
                .catch(error => {
                    console.error('에러 발생:', error);
                });
        }
    </script>
</head>
<body>
<header>
  <div class="container header-content">
    <a th:href="@{/static}" class="logo-container">
      <img th:src="@{/images/1.png}" alt="Mungpedia" class="logo-text">
      <img th:src="@{/images/3.png}" alt="Paw" class="logo-paw">
    </a>
    <nav>
      <a th:href="@{/static}">홈</a>
      <a th:href="@{/encyclopedia}">동물백과</a>
      <a th:href="@{/community}">커뮤니티</a>
      <a th:href="@{/write}">백과 게시기</a>
      <a th:href="@{/management}" class="active">관리자 페이지</a>
      <th:block sec:authorize="isAuthenticated()">
        <button class="btn" onclick="location.href='/logout'">로그아웃</button>
      </th:block>
    </nav>
  </div>
</header>

<main class="container">
  <div class="board-container">
    <div class="board-header">
      <h1 class="board-title">수정 요청 확인 페이지</h1>
      <div class="board-actions">
      </div>
    </div>


    <!-- 게시글 목록 -->
    <form id="post-list">
      <div class="post-item" th:each="board : ${editRequest}"
           data-board-id="${board.id}"
           data-member-email="${board.requestedMember.email}">
        <div class="post-info">
          <label>
            <span th:text="'요청번호 : ' + ${board.id}">요청번호</span>
            <span th:text="'요청번호 : ' + ${board.pediaEditRequestCode}">요청코드</span>
            <span th:text="'확인용 : ' + ${board.pediaVersion.pediaContent.id}">확인용</span>
            <span th:text="'요청자 : ' + ${board.requestedMember.email}">요청자</span>
            <span th:text="'강아지 종류 : ' + ${board.pediaVersion.pediaContent.breed}">강아지 종류</span>
            <button type="button"
                    th:onclick="handleApprove([[${board.pediaEditRequestCode}]], [[${board.requestedMember.email}]])">
              승인
            </button>

            <button type="button"
                    th:onclick="handleDecline([[${board.pediaEditRequestCode}]], [[${board.requestedMember.email}]])">
              거절
            </button>

            <a class="btn btn-submit"
               th:href="@{/view-edit-request/detail/{id}(id = ${board.pediaVersion.pediaContent.id})}">상세확인이동</a>
          </label>
        </div>
      </div>
    </form>

        <!-- 게시글 목록 -->
        <form id = "post-list">
            <div class="post-item" th:each="board : ${editRequest}"
                 data-board-id="${board.id}"
                 data-member-email="${board.requestedMember.email}">
                <div class="post-info">
                    <label>
                        <span th:text="'요청번호 : ' + ${board.id}">요청번호</span>
                        <span th:text="'요청번호 : ' + ${board.pediaEditRequestCode}">요청코드</span>
                        <span th:text="'확인용 : ' + ${board.pediaVersion.pediaContent.id}">확인용</span>
                        <span th:text="'요청자 : ' + ${board.requestedMember.email}">요청자</span>
                        <span th:text="'강아지 종류 : ' + ${board.pediaVersion.pediaContent.breed}">강아지 종류</span>
                        <button type="button" th:onclick="handleApprove([[${board.pediaEditRequestCode}]], [[${board.requestedMember.email}]] , [[${board.pediaVersion.pediaContent.breed}]])">
                            승인
                        </button>

                        <button type="button" th:onclick="handleDecline([[${board.pediaEditRequestCode}]], [[${board.requestedMember.email}]]  )">
                            거절
                        </button>

                        <a class="btn btn-submit" th:href="@{/view-edit-request/detail/{id}(id = ${board.pediaVersion.pediaContent.id})}">상세확인이동</a>
                    </label>
                </div>
            </div>
        </form>


<!--        수정요청 이랑 엮어야함 , 상세확인 엮어야 하고, 인-->



<!--        &lt;!&ndash; 페이지네이션 &ndash;&gt;-->
<!--        <div class="pagination">-->
<!--            <a th:href="@{/community(page=1)}" th:class="${currentPage == 1 ? 'disabled' : ''}">&lt;&lt;</a>-->
<!--            <a th:each="pageNum : ${#numbers.sequence(startPage, endPage)}"-->
<!--               th:href="@{/community(page=${pageNum})}"-->
<!--               th:class="${pageNum == currentPage ? 'active' : ''}"-->
<!--               th:text="${pageNum}">1</a>-->
<!--            <a th:href="@{/community(page=${totalPages})}"-->
<!--               th:class="${currentPage == totalPages ? 'disabled' : ''}">&gt;&gt;</a></div>-->
          </div>



</main>

<!-- 글쓰기 모달 -->
<div id="writeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">글쓰기</h3>
      <button class="close-modal" onclick="closeWriteModal()">&times;</button>
    </div>
    <form class="write-form" id="writeForm" onsubmit="submitPost(event)"
          enctype="multipart/form-data">
      <div class="form-group">
        <label for="postTitle">제목</label>
        <input type="text" id="postTitle" name="title" required placeholder="제목을 입력하세요">
      </div>

      <div class="form-group">
        <label for="postContent">내용</label>
        <textarea id="postContent" name="content" required placeholder="내용을 입력하세요"></textarea>
      </div>

      <div class="form-group">
        <label>파일 첨부</label>
        <div id="fileUploadZone" class="file-upload-container">
          <div class="file-upload-section">
            <label for="files" class="file-label">
              <i class="fas fa-cloud-upload-alt"></i>
              파일 선택 또는 드래그하여 업로드
              <small>(이미지 또는 동영상)</small>
            </label>
            <input type="file" id="files" name="files"
                   accept="image/*,video/*" multiple
                   onchange="handleFileUpload(Array.from(this.files))">
            <div id="filePreviewContainer" class="preview-container"></div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-cancel" onclick="closeWriteModal()">취소</button>
        <button type="submit" class="btn-submit">등록</button>
      </div>
    </form>
  </div>
</div>

<script th:inline="javascript">
  // 전역 변수 선언
  let uploadedFiles = [];

  // DOM이 로드되면 이벤트 리스너 설정
  document.addEventListener('DOMContentLoaded', function () {
    initializeEventListeners();
  });

  // 이벤트 리스너 초기화
  function initializeEventListeners() {
    const writeBtn = document.querySelector('.write-btn');
    const modal = document.getElementById('writeModal');
    const writeForm = document.getElementById('writeForm');

    writeBtn.addEventListener('click', openWriteModal);
    document.addEventListener('keydown', handleEscapeKey);
    modal.addEventListener('click', handleOutsideClick);
    writeForm.addEventListener('submit', submitPost);

    // 드래그 앤 드롭 이벤트 설정
    const dropZone = document.getElementById('fileUploadZone');
    dropZone.addEventListener('dragover', handleDragOver);
    dropZone.addEventListener('drop', handleFileDrop);
  }

  function handleDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    event.currentTarget.classList.add('dragover');
  }

  function handleFileDrop(event) {
    event.preventDefault();
    event.stopPropagation();
    event.currentTarget.classList.remove('dragover');

    const files = Array.from(event.dataTransfer.files);
    handleFileUpload(files);
  }

  function handleFileUpload(files) {
    files.forEach(file => {
      if (validateFile(file)) {
        createPreview(file);
        uploadedFiles.push(file);
      }
    });
  }

  // 파일 유효성 검사
  function validateFile(file) {
    const validTypes = ['image/', 'video/'];
    const isValidType = validTypes.some(type => file.type.startsWith(type));

    if (!isValidType) {
      alert('이미지 또는 동영상 파일만 업로드할 수 있습니다.');
      return false;
    }
    return true;
  }

  // 미리보기 생성
  function createPreview(file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      const previewContainer = document.getElementById('filePreviewContainer');
      const previewItem = createPreviewItem(e.target.result, file);
      previewContainer.appendChild(previewItem);
    };
    reader.readAsDataURL(file);
  }

  function createPreviewItem(src, file) {
    const div = document.createElement('div');
    div.className = 'preview-item';

    const media = file.type.startsWith('image/') ? new Image() : document.createElement('video');
    media.src = src;
    if (file.type.startsWith('video/')) {
      media.controls = true;
    }

    const removeButton = createRemoveButton(div, file);
    const fileInfo = createFileInfo(file);

    div.appendChild(media);
    div.appendChild(removeButton);
    div.appendChild(fileInfo);

    return div;
  }

  function createRemoveButton(container, file) {
    const button = document.createElement('button');
    button.className = 'remove-file';
    button.innerHTML = '×';
    button.onclick = () => removeFile(container, file);
    return button;
  }

  function createFileInfo(file) {
    const div = document.createElement('div');
    div.className = 'file-info';
    const fileType = file.type.startsWith('image/') ? '이미지' : '동영상';
    div.textContent = `${fileType} - ${formatFileSize(file.size)}`;
    return div;
  }

  function removeFile(element, file) {
    uploadedFiles = uploadedFiles.filter(f => f !== file);
    element.remove();
  }

  // 미리보기 초기화
  function clearPreviews() {
    document.getElementById('filePreviewContainer').innerHTML = '';
    uploadedFiles = [];
  }

  // 폼 제출 처리
  async function submitPost(event) {
    event.preventDefault();

    try {
      const formData = new FormData();
      const title = document.getElementById('postTitle').value;
      const content = document.getElementById('postContent').value;

      formData.append('title', title);
      formData.append('content', content);

      // 파일 추가
      uploadedFiles.forEach((file, index) => {
        formData.append('files', file);
      });

      const response = await fetch('/api/posts', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        throw new Error('게시글 등록에 실패했습니다.');
      }

      const result = await response.json();
      alert('게시글이 등록되었습니다.');
      closeWriteModal();
      location.reload();
    } catch (error) {
      console.error('Error:', error);
      alert(error.message || '게시글 등록 중 오류가 발생했습니다.');
    }

    //
    // function handleApprove(reqId, userEmail) {
    //     // // 부모 요소에서 data-* 속성 읽기
    //     // const postItem = button.closest('.post-item'); // 버튼의 부모 요소 찾기
    //     // const code = postItem.getAttribute('data-board-id');
    //     // const memberEmail = postItem.getAttribute('data-member-email');
    //     //
    //     // console.log('Board ID:', boardId);
    //     // console.log('Member Email:', memberEmail);
    //
    //     // Fetch API를 통해 수정 승인 요청 보내기
    //     fetch('/RequestAccept', {
    //         method: 'POST',
    //         headers: {
    //             'Content-Type': 'application/json',
    //         },
    //         body: JSON.stringify({
    //             code: reqId,
    //             memberEmail: userEmail
    //         }),
    //     })
    //         .then(response => {
    //             if (!response.ok) {
    //                 throw new Error('네트워크 응답 오류');
    //             }
    //             return response.json();
    //         })
    //         .then(data => {
    //             alert('수정 요청이 승인되었습니다.');
    //             window.location.reload(); // 필요시 페이지 리로드
    //         })
    //         .catch(error => {
    //             console.error('에러 발생:', error);
    //         });
    // }
  }
</script>
</body>
</html>