<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>멍피디아 - 커뮤니티</title>

  <style>
    /* 기본 스타일 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background-color: #f9fafb;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* 헤더 스타일 */
    header {
      background-color: #fff3e0;
      padding: 1rem;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .logo-text, .logo-paw {
      height: 35px;
      width: auto;
    }

    .logo-paw {
      height: 20px;
    }

    /* 네비게이션 */
    nav {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }

    nav a {
      text-decoration: none;
      color: #4b5563;
    }

    nav a.active {
      color: #f97316;
      font-weight: bold;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn-login {
      background-color: white;
    }

    .btn-signup {
      background-color: #f97316;
      color: white;
    }

    /* 게시판 컨테이너 */
    .board-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin: 2rem auto;
    }

    .board-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .board-title {
      font-size: 1.5rem;
      color: #111827;
      margin-bottom: 0.5rem;
    }

    /* 게시판 액션 */
    .board-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1rem 0;
    }

    .write-btn {
      background-color: #f97316;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .write-btn:hover {
      background-color: #ea580c;
    }

    /* 검색 폼 */
    .search-form {
      display: flex;
      gap: 0.5rem;
    }

    .search-select,
    .search-input {
      padding: 0.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
    }

    .search-input {
      width: 200px;
    }

    /* 게시글 목록 */
    .post-list {
      width: 100%;
    }

    .post-item {
      display: flex;
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
      transition: background-color 0.2s;
    }

    .post-item:hover {
      background-color: #f9fafb;
    }

    .post-info {
      flex-grow: 1;
    }

    .post-title {
      font-weight: 500;
      color: #111827;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }

    .post-meta {
      font-size: 0.875rem;
      color: #6b7280;
      display: flex;
      gap: 1rem;
    }

    .post-stats {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.875rem;
      color: #6b7280;
    }

    /* 페이지네이션 */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 0.25rem;
      padding: 1rem;
    }

    .pagination a {
      padding: 0.5rem 0.75rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.25rem;
      color: #4b5563;
      text-decoration: none;
      transition: all 0.2s;
    }

    .pagination a:hover {
      background-color: #f3f4f6;
    }

    .pagination a.active {
      background-color: #f97316;
      color: white;
      border-color: #f97316;
    }

    .pagination a.disabled {
      color: #9ca3af;
      pointer-events: none;
      background-color: #f3f4f6;
    }

    /* 모달 스타일 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .modal-content {
      position: relative;
      background-color: white;
      max-width: 800px;
      width: 90%;
      margin: 2rem auto;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
      transition: color 0.2s;
    }

    .close-modal:hover {
      color: #111827;
    }

    /* 파일 업로드 */
    .file-upload-container {
      border: 2px dashed #e5e7eb;
      padding: 2rem;
      border-radius: 0.5rem;
      background-color: #f9fafb;
      transition: border-color 0.3s, background-color 0.3s;
      text-align: center;
    }

    .file-upload-container.dragover {
      border-color: #f97316;
      background-color: #fff7ed;
    }

    .file-upload-section {
      margin: 1rem 0;
    }

    .file-label {
      display: inline-block;
      padding: 1rem 2rem;
      background-color: #f97316;
      color: white;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .file-label:hover {
      background-color: #ea580c;
    }

    .file-label i {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      display: block;
    }

    .file-label small {
      display: block;
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }

    /* 미리보기 */
    .preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1rem;
      justify-content: center;
    }

    .preview-item {
      position: relative;
      width: 150px;
      height: 150px;
      border-radius: 0.5rem;
      overflow: hidden;
    }

    .preview-item img,
    .preview-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .remove-file {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 24px;
      height: 24px;
      background-color: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: background-color 0.2s;
    }

    .remove-file:hover {
      background-color: rgb(239, 68, 68);
    }

    .file-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 0.25rem;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 0.75rem;
      text-align: center;
    }

    /* 입력 필드 */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #4b5563;
      font-weight: bold;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #f97316;
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
    }

    .form-group textarea {
      min-height: 200px;
      resize: vertical;
    }

    /* 모달 푸터 */
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid #e5e7eb;
    }

    .btn-submit,
    .btn-cancel {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    .btn-submit {
      background-color: #f97316;
      color: white;
    }

    .btn-submit:hover {
      background-color: #ea580c;
    }

    .btn-cancel {
      background-color: #e5e7eb;
      color: #4b5563;
    }

    .btn-cancel:hover {
      background-color: #d1d5db;
    }

    /* 파일 입력 숨기기 */
    input[type="file"] {
      display: none;
    }

    /* 반응형 디자인 */
    @media (max-width: 768px) {
      .board-actions {
        flex-direction: column;
        gap: 1rem;
      }

      .search-form {
        width: 100%;
      }

      .search-input {
        width: 100%;
      }

      .preview-item {
        width: calc(50% - 0.5rem);
      }
    }

    @media (max-width: 480px) {
      .preview-item {
        width: 100%;
      }

      .modal-content {
        padding: 1rem;
      }

      .file-label {
        padding: 0.75rem 1rem;
      }
    }
  </style>

</head>
<body>
<header>
  <div class="container header-content">
    <a th:href="@{/static}" class="logo-container">
      <img th:src="@{/images/1.png}" alt="Mungpedia" class="logo-text">
      <img th:src="@{/images/3.png}" alt="Paw" class="logo-paw">
    </a>
    <nav>
      <a th:href="@{/static}">홈</a>
      <a th:href="@{/encyclopedia}">동물백과</a>
      <a th:href="@{/community}" class="active">커뮤니티</a>
      <a th:href="@{/write}">백과 게시기</a>
      <th:block sec:authorize="isAnonymous()">
        <button class="btn btn-login" onclick="location.href='/login'">로그인</button>
        <button class="btn btn-signup" onclick="location.href='/signup'">회원가입</button>
      </th:block>
      <th:block sec:authorize="isAuthenticated()">
        <button class="btn" onclick="location.href='/logout'">로그아웃</button>
      </th:block>
    </nav>
  </div>
</header>

<main class="container">
  <div class="board-container">
    <div class="board-header">
      <h1 class="board-title">커뮤니티</h1>
      <div class="board-actions">
        <button class="write-btn" onclick="location.href='/posts/new'">글쓰기</button>

        <form class="search-form" action="/posts" method="get">
          <label for="sort">정렬 기준:</label>
          <select class="search-select" id="sort" name="sort" onchange="this.form.submit()">
            <option value="createdDate" th:selected="${selectedSort == 'createdDate'}">날짜</option>
            <option value="view" th:selected="${selectedSort == 'view'}">조회수</option>
          </select>
        </form>
      </div>
    </div>

    <!-- 게시글 목록 -->
    <div class="post-list">
      <div class="post-item" th:each="post : ${posts}">
        <div class="post-info">
          <a class="post-title" th:href="@{/posts/{id}(id=${post.id})}" th:text="${post.title}"></a>
          <div class="post-meta">
            <span th:text="${post.memberNickName}"></span>
            <span th:text="${post.formattedCreatedAt}"></span>
            <span th:text="${post.views}"></span>
            <span th:text="${post.commentCount}"></span>
          </div>
        </div>
        <div class="post-stats">
          <span>조회 <th:block th:text="${post.views}"></th:block></span>
          <span>댓글 <th:block th:text="${post.commentCount}"></th:block></span>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- 글쓰기 모달 -->
<div id="writeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">글쓰기</h3>
      <button class="close-modal" onclick="closeWriteModal()">&times;</button>
    </div>
    <form class="write-form" id="writeForm" onsubmit="submitPost(event)"
          enctype="multipart/form-data">
      <div class="form-group">
        <label for="postTitle">제목</label>
        <input type="text" id="postTitle" name="title" required placeholder="제목을 입력하세요">
      </div>

      <div class="form-group">
        <label for="postContent">내용</label>
        <textarea id="postContent" name="content" required placeholder="내용을 입력하세요"></textarea>
      </div>

      <div class="form-group">
        <label>파일 첨부</label>
        <div id="fileUploadZone" class="file-upload-container">
          <div class="file-upload-section">
            <label for="files" class="file-label">
              <i class="fas fa-cloud-upload-alt"></i>
              파일 선택 또는 드래그하여 업로드
              <small>(이미지 또는 동영상)</small>
            </label>
            <input type="file" id="files" name="files"
                   accept="image/*,video/*" multiple
                   onchange="handleFileUpload(Array.from(this.files))">
            <div id="filePreviewContainer" class="preview-container"></div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-cancel" onclick="closeWriteModal()">취소</button>
        <button type="submit" class="btn-submit">등록</button>
      </div>
    </form>
  </div>
</div>

<script>
  // 전역 변수 선언
  let uploadedFiles = [];

  // DOM이 로드되면 이벤트 리스너 설정
  document.addEventListener('DOMContentLoaded', function () {
    initializeEventListeners();
  });

  // 이벤트 리스너 초기화
  function initializeEventListeners() {
    const writeBtn = document.querySelector('.write-btn');
    const modal = document.getElementById('writeModal');
    const writeForm = document.getElementById('writeForm');

    writeBtn.addEventListener('click', openWriteModal);
    document.addEventListener('keydown', handleEscapeKey);
    modal.addEventListener('click', handleOutsideClick);
    writeForm.addEventListener('submit', submitPost);

    // 드래그 앤 드롭 이벤트 설정
    const dropZone = document.getElementById('fileUploadZone');
    dropZone.addEventListener('dragover', handleDragOver);
    dropZone.addEventListener('drop', handleFileDrop);
  }

  function handleDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    event.currentTarget.classList.add('dragover');
  }

  function handleFileDrop(event) {
    event.preventDefault();
    event.stopPropagation();
    event.currentTarget.classList.remove('dragover');

    const files = Array.from(event.dataTransfer.files);
    handleFileUpload(files);
  }

  function handleFileUpload(files) {
    files.forEach(file => {
      if (validateFile(file)) {
        createPreview(file);
        uploadedFiles.push(file);
      }
    });
  }

  // 파일 유효성 검사
  function validateFile(file) {
    const validTypes = ['image/', 'video/'];
    const isValidType = validTypes.some(type => file.type.startsWith(type));

    if (!isValidType) {
      alert('이미지 또는 동영상 파일만 업로드할 수 있습니다.');
      return false;
    }
    return true;
  }

  // 미리보기 생성
  function createPreview(file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      const previewContainer = document.getElementById('filePreviewContainer');
      const previewItem = createPreviewItem(e.target.result, file);
      previewContainer.appendChild(previewItem);
    };
    reader.readAsDataURL(file);
  }

  function createPreviewItem(src, file) {
    const div = document.createElement('div');
    div.className = 'preview-item';

    const media = file.type.startsWith('image/') ? new Image() : document.createElement('video');
    media.src = src;
    if (file.type.startsWith('video/')) {
      media.controls = true;
    }

    const removeButton = createRemoveButton(div, file);
    const fileInfo = createFileInfo(file);

    div.appendChild(media);
    div.appendChild(removeButton);
    div.appendChild(fileInfo);

    return div;
  }

  function createRemoveButton(container, file) {
    const button = document.createElement('button');
    button.className = 'remove-file';
    button.innerHTML = '×';
    button.onclick = () => removeFile(container, file);
    return button;
  }

  function createFileInfo(file) {
    const div = document.createElement('div');
    div.className = 'file-info';
    const fileType = file.type.startsWith('image/') ? '이미지' : '동영상';
    div.textContent = `${fileType} - ${formatFileSize(file.size)}`;
    return div;
  }

  function removeFile(element, file) {
    uploadedFiles = uploadedFiles.filter(f => f !== file);
    element.remove();
  }

  // 미리보기 초기화
  function clearPreviews() {
    document.getElementById('filePreviewContainer').innerHTML = '';
    uploadedFiles = [];
  }

  // 폼 제출 처리
  async function submitPost(event) {
    event.preventDefault();

    try {
      const formData = new FormData();
      const title = document.getElementById('postTitle').value;
      const content = document.getElementById('postContent').value;

      formData.append('title', title);
      formData.append('content', content);

      // 파일 추가
      uploadedFiles.forEach((file, index) => {
        formData.append('files', file);
      });

      const response = await fetch('/api/posts', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        throw new Error('게시글 등록에 실패했습니다.');
      }

      const result = await response.json();
      alert('게시글이 등록되었습니다.');
      closeWriteModal();
      location.reload();
    } catch (error) {
      console.error('Error:', error);
      alert(error.message || '게시글 등록 중 오류가 발생했습니다.');
    }
  }
</script>
</body>
</html>